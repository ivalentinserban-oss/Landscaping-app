{% extends "base.html" %}
{% block title %}Invoice - Job {{ job.id }}{% endblock %}
{% block head_extra %}
<style>
    .record-payment-form { max-width: 520px; }
    .record-payment-fields { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 1rem; }
    .record-payment-field { min-width: 120px; }
    .record-payment-field:first-child { flex: 1; min-width: 100px; max-width: 140px; }
    .record-payment-field select.form-select { min-width: 100px; }
    .record-payment-submit .form-label { visibility: hidden; }
    @media (max-width: 500px) {
        .record-payment-fields { flex-direction: column; align-items: stretch; }
        .record-payment-field { max-width: none; }
        .record-payment-submit .form-label { display: none; }
    }
</style>
{% endblock %}
{% block content %}
<h1 class="mb-3">Invoice for Job #{{ job.id }}</h1>
<div class="mb-3 d-flex justify-content-between align-items-center flex-wrap">
    <div>
        <a href="/jobs/{{ job.id }}" class="btn btn-secondary">Back to Job</a>
        {% if weasyprint %}
        <a href="/jobs/{{ job.id }}/invoice.pdf" class="btn btn-outline-secondary ms-2">Download PDF</a>
        {% endif %}
    </div>
    <div>
        {% if job.invoice_status == 'Paid' %}
        <span class="btn btn-success disabled">Paid</span>
        {% elif job.invoice_status == 'Sent' %}
        <span class="btn btn-outline-primary disabled">Invoice Sent</span>
        {% else %}
        <form method="post" action="/jobs/{{ job.id }}/mark_invoice_sent" style="display:inline;">
            <button type="submit" class="btn btn-primary">Mark Invoice Sent</button>
        </form>
        {% endif %}
    </div>
</div>
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>From</h5>
                <p>
                    Landscaping Contractor<br>
                    Nashville, TN
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <h5>To</h5>
                <p>
                    {{ job.client_name }}<br>
                    {% if job.client_address %}{{ job.client_address }}<br>{% endif %}
                    {% if job.client_phone %}{{ job.client_phone }}<br>{% endif %}
                    {% if job.client_email %}{{ job.client_email }}{% endif %}
                </p>
            </div>
        </div>
        <hr>
        <p><strong>Invoice Date:</strong> {{ job.scheduled_date[:10] }}</p>
        <p><strong>Job Description:</strong> {{ job.description }}</p>
    </div>
</div>
<h4>Job Summary</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Description</th>
            <th class="text-end">Estimated</th>
            <th class="text-end">Actual</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Hours</td>
            <td class="text-end">{{ job.estimated_hours }}</td>
            <td class="text-end">{{ job.actual_hours }}</td>
        </tr>
        <tr>
            <td>Cost ($)</td>
            <td class="text-end">{{ '%.2f'|format(job.estimated_cost) }}</td>
            <td class="text-end">{{ '%.2f'|format(job.actual_cost) }}</td>
        </tr>
    </tbody>
</table>
{% if tasks %}
<h4>Tasks</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Task</th>
            <th class="text-center">Completed</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr>
            <td>{{ task.description }}</td>
            <td class="text-center">{{ 'Yes' if task.completed else 'No' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
<div class="mt-4">
    {% if payments %}
    <h4>Payments</h4>
    <table class="table table-bordered mb-3">
        <thead>
            <tr>
                <th>Date</th>
                <th>Method</th>
                <th class="text-end">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for p in payments %}
            <tr>
                <td>{{ p.paid_at[:10] if p.paid_at else 'â€”' }}</td>
                <td>{{ p.method }}</td>
                <td class="text-end">${{ '%.2f'|format(p.amount) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p><strong>Total Paid:</strong> ${{ '%.2f'|format(total_paid) }}</p>
    <p><strong>Amount Due:</strong> ${{ '%.2f'|format(job.actual_cost - total_paid) }}</p>
    {% else %}
    <p><strong>Total Due:</strong> ${{ '%.2f'|format(job.actual_cost) }}</p>
    {% endif %}
    {% if job.invoice_status != 'Paid' %}
    <hr>
    <h5 class="mb-3">Record Payment</h5>
    <form method="post" action="/jobs/{{ job.id }}/payments" class="record-payment-form">
        <div class="record-payment-fields">
            <div class="record-payment-field">
                <label for="amount" class="form-label">Amount ($)</label>
                <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
            </div>
            <div class="record-payment-field">
                <label for="method" class="form-label">Method</label>
                <select class="form-select" id="method" name="method">
                    <option value="Cash">Cash</option>
                    <option value="Check">Check</option>
                    <option value="Card">Card</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="record-payment-field record-payment-submit">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-success">Record Payment</button>
            </div>
        </div>
    </form>
    {% endif %}
    <p class="mt-3 mb-0">Thank you for your business!</p>
</div>
{% endblock %}