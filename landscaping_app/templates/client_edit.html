{% extends "base.html" %}
{% block title %}Edit Client - Landscaping App{% endblock %}
{% block head_extra %}
<style>
    .autocomplete-wrap { position: relative; }
    .address-suggestions {
        position: absolute; z-index: 20; top: calc(100% + 4px); left: 0; right: 0;
        margin: 0; padding: 4px 0; list-style: none; background: #fff;
        border: 1px solid #d7e0d8; border-radius: 10px;
        box-shadow: 0 10px 24px rgba(31, 42, 36, 0.14);
        max-height: 220px; overflow-y: auto;
    }
    .address-suggestions li { padding: 9px 11px; cursor: pointer; }
    .address-suggestions li:hover { background: #edf5ee; }
    .help-text { display: block; margin-top: 6px; color: #5f6f64; font-size: 0.9rem; }
</style>
{% endblock %}
{% block content %}
<h1 class="mb-3">Edit Client</h1>
<form method="post" action="/clients/{{ client.id }}/edit">
    <div class="mb-3">
        <label for="name" class="form-label">Name</label>
        <input type="text" class="form-control" id="name" name="name" value="{{ client.name }}" required>
    </div>
    <div class="mb-3">
        <label for="address" class="form-label">Address</label>
        <div class="autocomplete-wrap">
            <input type="text" class="form-control" id="address" name="address" value="{{ client.address or '' }}" autocomplete="off">
            <ul id="address-suggestions" class="address-suggestions" hidden></ul>
        </div>
        <small id="address-help" class="help-text">
            {% if google_maps_api_key %}Address suggestions powered by Google Maps (fallback enabled).{% else %}Address suggestions enabled (fallback mode).{% endif %}
        </small>
    </div>
    <div class="mb-3">
        <label for="phone" class="form-label">Phone</label>
        <input type="tel" class="form-control" id="phone" name="phone" value="{{ client.phone or '' }}">
    </div>
    <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" name="email" value="{{ client.email or '' }}">
    </div>
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="/clients/{{ client.id }}" class="btn btn-secondary">Cancel</a>
</form>
{% endblock %}
{% block body_extra %}
<script>
    function escapeHtml(v) { return String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function clearSuggestions() { var el = document.getElementById('address-suggestions'); if (el) { el.innerHTML = ''; el.hidden = true; } }
    function renderSuggestions(items) {
        var list = document.getElementById('address-suggestions'), input = document.getElementById('address');
        if (!list || !input) return;
        if (!items.length) { clearSuggestions(); return; }
        list.innerHTML = items.map(function(item) { return '<li data-address="' + escapeHtml(item) + '">' + escapeHtml(item) + '</li>'; }).join('');
        list.hidden = false;
        list.querySelectorAll('li').forEach(function(li) {
            li.addEventListener('click', function() { input.value = li.getAttribute('data-address'); clearSuggestions(); });
        });
    }
    var debounceTimer, pendingController;
    document.getElementById('address').addEventListener('input', function() {
        var q = this.value.trim();
        clearTimeout(debounceTimer);
        if (q.length < 3) { clearSuggestions(); return; }
        debounceTimer = setTimeout(function() {
            if (pendingController) pendingController.abort();
            pendingController = new AbortController();
            fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=' + encodeURIComponent(q), { signal: pendingController.signal, headers: { 'Accept': 'application/json' } })
                .then(function(r) { return r.ok ? r.json() : []; })
                .then(function(data) { renderSuggestions(data.map(function(row) { return row.display_name; })); })
                .catch(function() { clearSuggestions(); });
        }, 250);
    });
    document.getElementById('address').addEventListener('blur', function() { setTimeout(clearSuggestions, 120); });
</script>
{% endblock %}
